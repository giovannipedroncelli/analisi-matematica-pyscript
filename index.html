<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Analisi matematica con PyScript</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script type="py-config">
    {
      "packages": ["sympy", "numpy", "matplotlib"]
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

  <h1>Analisi matematica</h1>

  <div class="mb-3">
    <input type="text" id="funzione" class="form-control" value="x**2 + 3*x + 2">
  </div>

  <div class="mb-3">
    <select id="opzione" class="form-select">
      <option value="derivata">Derivata</option>
      <option value="integrale_indefinito">Integrale Indefinito</option>
      <option value="integrale_definito">Integrale Definito</option>
      <option value="limite">Limite</option>
    </select>
  </div>

  <div class="mb-3" id="parametri_extra">
    <input type="text" id="limite_inf" class="form-control mb-2" placeholder="Limite inferiore" style="display:none">
    <input type="text" id="limite_sup" class="form-control mb-2" placeholder="Limite superiore" style="display:none">
    <input type="text" id="punto_limite" class="form-control" placeholder="x tende a..." style="display:none">
  </div>

  <button id="calcola" class="btn btn-warning">Calcola</button>

  <h3 class="mt-4">Risultato:</h3>
  <pre id="output"></pre>

  <h3 class="mt-4">Grafico:</h3>
  <div id="grafico"></div>

  <py-script>
from pyscript import Element, display
import sympy as sp
import numpy as np
import matplotlib.pyplot as plt

x = sp.Symbol('x')

def mostra_parametri():
    scelta = Element("opzione").value
    Element("limite_inf").element.style.display = "none"
    Element("limite_sup").element.style.display = "none"
    Element("punto_limite").element.style.display = "none"
    if scelta == "integrale_definito":
        Element("limite_inf").element.style.display = "block"
        Element("limite_sup").element.style.display = "block"
    elif scelta == "limite":
        Element("punto_limite").element.style.display = "block"

def calcola():
    out = Element("output")
    out.clear()
    plot = Element("grafico")
    plot.clear()
    try:
        f_expr = Element("funzione").value
        f = sp.sympify(f_expr)
        scelta = Element("opzione").value

        if scelta == "derivata":
            risultato = sp.diff(f, x)
        elif scelta == "integrale_indefinito":
            risultato = sp.integrate(f, x)
        elif scelta == "integrale_definito":
            a = sp.sympify(Element("limite_inf").value)
            b = sp.sympify(Element("limite_sup").value)
            risultato = sp.integrate(f, (x, a, b))
        elif scelta == "limite":
            t = Element("punto_limite").value
            t_val = sp.oo if t == "oo" else -sp.oo if t == "-oo" else sp.sympify(t)
            risultato = sp.limit(f, x, t_val)

        out.write(f"Risultato: {sp.latex(risultato)}")

        f_lambdified = sp.lambdify(x, f, "numpy")
        xs = np.linspace(-10, 10, 500)
        ys = f_lambdified(xs)

        fig, ax = plt.subplots()
        ax.plot(xs, ys)
        ax.set_title("Grafico della funzione")
        ax.grid()
        display(fig, target="grafico")

    except Exception as e:
        out.write(f"Errore: {e}")

Element("opzione").element.onchange = lambda e: mostra_parametri()
Element("calcola").element.onclick = lambda e: calcola()
  </py-script>
</body>
</html>
