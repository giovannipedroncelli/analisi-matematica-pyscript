<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Analisi matematica con PyScript</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <py-env>
    - sympy
    - numpy
    - matplotlib
  </py-env>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
  <h1>Analisi matematica con PyScript</h1>

  <div class="mb-3">
    <input type="text" id="funzione" class="form-control" value="x**2 + 3*x + 2">
  </div>

  <div class="mb-3">
    <select id="opzione" class="form-select">
      <option value="derivata">Derivata</option>
      <option value="integrale_indefinito">Integrale Indefinito</option>
      <option value="integrale_definito">Integrale Definito</option>
      <option value="limite">Limite</option>
    </select>
  </div>

  <div id="extra" class="mb-3">
    <input type="text" id="limite_inf" class="form-control mb-2" placeholder="Limite inferiore" style="display:none">
    <input type="text" id="limite_sup" class="form-control mb-2" placeholder="Limite superiore" style="display:none">
    <input type="text" id="punto_limite" class="form-control" placeholder="x tende a..." style="display:none">
  </div>

  <button id="calcola" class="btn btn-warning">Calcola</button>

  <h3>Risultato:</h3>
  <pre id="output"></pre>

  <h3>Grafico:</h3>
  <div id="plot"></div>

  <py-script>
from pyscript import Element, create_proxy, write
import sympy as sp
import numpy as np
import matplotlib.pyplot as plt

x = sp.symbols('x')

def onchange(event):
    v = Element("opzione").value
    Element("limite_inf").element.style.display = "none"
    Element("limite_sup").element.style.display = "none"
    Element("punto_limite").element.style.display = "none"
    if v == "integrale_definito":
        Element("limite_inf").element.style.display = "block"
        Element("limite_sup").element.style.display = "block"
    elif v == "limite":
        Element("punto_limite").element.style.display = "block"

def oncalc(event):
    output = Element("output")
    plot_div = Element("plot")
    output.clear()
    plot_div.clear()
    try:
        f = sp.sympify(Element("funzione").value)
        opt = Element("opzione").value
        if opt=="derivata":
            res = sp.diff(f, x)
        elif opt=="integrale_indefinito":
            res = sp.integrate(f, x)
        elif opt=="integrale_definito":
            a = sp.sympify(Element("limite_inf").value)
            b = sp.sympify(Element("limite_sup").value)
            res = sp.integrate(f, (x, a, b))
        else:
            pt = Element("punto_limite").value
            punkt = sp.oo if pt=="oo" else -sp.oo if pt=="-oo" else sp.sympify(pt)
            res = sp.limit(f, x, punkt)

        output.write(f"{sp.latex(res)}")

        xs = np.linspace(-10,10,400)
        ys = sp.lambdify(x, f, "numpy")(xs)
        fig, ax = plt.subplots()
        ax.plot(xs, ys); ax.grid()
        write("plot", fig)

    except Exception as e:
        output.write(f"Errore: {e}")

# associa callback corretti
Element("opzione").element.onchange = create_proxy(onchange)
Element("calcola").element.onclick = create_proxy(oncalc)
  </py-script>
</body>
</html>
